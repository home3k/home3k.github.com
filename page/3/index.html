<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>Home3k&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="home3k&apos;s tech blog. 写写，想想">
<meta property="og:type" content="website">
<meta property="og:title" content="Home3k&#39;s blog">
<meta property="og:url" content="http://home3k.me/page/3/index.html">
<meta property="og:site_name" content="Home3k&#39;s blog">
<meta property="og:description" content="home3k&apos;s tech blog. 写写，想想">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Home3k&#39;s blog">
<meta name="twitter:description" content="home3k&apos;s tech blog. 写写，想想">
  
    <link rel="alternative" href="/atom.xml" title="Home3k&#39;s blog" type="application/atom+xml">
  
  
    <link rel="icon" href="img/logo.png">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="img/logo.png" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">home3k</a></h1>
		</hgroup>

		
		<p class="header-subtitle">写写，想想</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Menu</li>
						<li>标签</li>
						
						
						<li>关于我</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
							<li><a href="/tags/随笔">随笔</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="http://github.com/home3k" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="http://weibo.com/sukani" title="weibo">weibo</a>
					        
								<a class="twitter" target="_blank" href="https://twitter.com/home3k" title="twitter">twitter</a>
					        
								<a class="zhihu" target="_blank" href="http://www.zhihu.com/people/home3k" title="zhihu">zhihu</a>
					        
								<a class="facebook" target="_blank" href="https://www.facebook.com/home3k" title="facebook">facebook</a>
					        
								<a class="douban" target="_blank" href="https://www.douban.com/people/home3k" title="douban">douban</a>
					        
								<a class="mail" target="_blank" href="mailto:home3k@gmail.com" title="mail">mail</a>
					        
								<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Blog/" style="font-size: 14px;">Blog</a> <a href="/tags/CV/" style="font-size: 10px;">CV</a> <a href="/tags/Cache/" style="font-size: 12px;">Cache</a> <a href="/tags/DirectMemory/" style="font-size: 10px;">DirectMemory</a> <a href="/tags/Distributed-System/" style="font-size: 10px;">Distributed System</a> <a href="/tags/EnumSet/" style="font-size: 10px;">EnumSet</a> <a href="/tags/False-Sharing/" style="font-size: 10px;">False Sharing</a> <a href="/tags/G1/" style="font-size: 10px;">G1</a> <a href="/tags/GC/" style="font-size: 10px;">GC</a> <a href="/tags/Hexo/" style="font-size: 10px;">Hexo</a> <a href="/tags/JBlooming/" style="font-size: 10px;">JBlooming</a> <a href="/tags/JDBC/" style="font-size: 10px;">JDBC</a> <a href="/tags/Java/" style="font-size: 18px;">Java</a> <a href="/tags/Java-NIO/" style="font-size: 10px;">Java NIO</a> <a href="/tags/Matlab/" style="font-size: 10px;">Matlab</a> <a href="/tags/MySQL/" style="font-size: 10px;">MySQL</a> <a href="/tags/Plan/" style="font-size: 10px;">Plan</a> <a href="/tags/Raywenderlich/" style="font-size: 10px;">Raywenderlich</a> <a href="/tags/React-Native/" style="font-size: 10px;">React Native</a> <a href="/tags/Struts/" style="font-size: 16px;">Struts</a> <a href="/tags/Vert-x/" style="font-size: 10px;">Vert.x</a> <a href="/tags/Xcode/" style="font-size: 10px;">Xcode</a> <a href="/tags/voc-dpm/" style="font-size: 10px;">voc-dpm</a> <a href="/tags/创业/" style="font-size: 10px;">创业</a> <a href="/tags/思想/" style="font-size: 10px;">思想</a> <a href="/tags/成长/" style="font-size: 10px;">成长</a> <a href="/tags/翻译/" style="font-size: 10px;">翻译</a> <a href="/tags/设计/" style="font-size: 10px;">设计</a> <a href="/tags/读书比较/" style="font-size: 10px;">读书比较</a> <a href="/tags/转载/" style="font-size: 12px;">转载</a> <a href="/tags/随笔/" style="font-size: 20px;">随笔</a> <a href="/tags/音乐/" style="font-size: 12px;">音乐</a>
					</div>
				</section>
				
				
				

				
				
				<section class="switch-part switch-part3">
				
					<div id="js-aboutme">2010年从中科院计算所毕业,加入百度ECOM,经历了ALB.KASEM.FC,最终于2014年11月投入移动医疗创业.</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">home3k</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img lazy-src="img/logo.png" class="js-avatar">
			
			</div>
			<hgroup>
			  <h1 class="header-author">home3k</h1>
			</hgroup>
			
			<p class="header-subtitle">写写，想想</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
					<li><a href="/tags/随笔">随笔</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="http://github.com/home3k" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/sukani" title="weibo">weibo</a>
			        
						<a class="twitter" target="_blank" href="https://twitter.com/home3k" title="twitter">twitter</a>
			        
						<a class="zhihu" target="_blank" href="http://www.zhihu.com/people/home3k" title="zhihu">zhihu</a>
			        
						<a class="facebook" target="_blank" href="https://www.facebook.com/home3k" title="facebook">facebook</a>
			        
						<a class="douban" target="_blank" href="https://www.douban.com/people/home3k" title="douban">douban</a>
			        
						<a class="mail" target="_blank" href="mailto:home3k@gmail.com" title="mail">mail</a>
			        
						<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap">
  
    <article id="post-MySQL-Batch-Insert" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2014/07/29/MySQL-Batch-Insert/" class="article-date">
  	<time datetime="2014-07-29T08:49:49.000Z" itemprop="datePublished">2014-07-29</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/07/29/MySQL-Batch-Insert/">MySQL批量写入</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>MySQL批量写入，通常可以使用JDBCTemplate的batchUpdate</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">       <span class="keyword">public</span> <span class="keyword">int</span> [] batchUpdate (String sql, <span class="keyword">final</span> BatchPreparedStatementSetter pss) <span class="keyword">throws</span> DataAccessException &#123;</div><div class="line">     </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>使用后，针对批量操作，jdbc driver会render成批量语句发送给MySQL。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">jdbcTemplate.batchUpdate(sql, <span class="keyword">new</span> BatchPreparedStatementSetter() &#123;</div><div class="line">       <span class="meta">@Override</span></div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setValues</span><span class="params">(PreparedStatement ps, <span class="keyword">int</span> i)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">            Log log = logs.get(i);</div><div class="line">            ps.setLong(<span class="number">1</span>,log.getKeyid());</div><div class="line">            ps.setLong(<span class="number">2</span>,log.getUserid());</div><div class="line">            ps.setLong(<span class="number">3</span>,log.getPlanid());</div><div class="line">            ps.setLong(<span class="number">4</span>,log.getUnitid());</div><div class="line">            ps.setLong(<span class="number">5</span>,log.getLevel());</div><div class="line">            ps.setInt(<span class="number">6</span>,log.getType());</div><div class="line">      &#125;</div><div class="line">       <span class="meta">@Override</span></div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getBatchSize</span><span class="params">()</span> </span>&#123;</div><div class="line">             <span class="keyword">return</span> logs.size();</div><div class="line">      &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>今天一个线上case排查中发现，最终没有生效，SQL仍然是一条一条的发送出去，整体的性能下降明显。</p>
<p>查阅资料发现，原来MySQL默认是不支持batch的，jdbc driver虽然提供了batch接口，但是默认并没有开启，需要给JDBC Connection增加配置参数<code>rewriteBatchedStatements=true</code>，示例配置：</p>
<pre><code>jdbc:mysql://10.10.10.38:5858?characterEncoding=gbk&amp;rewriteBatchedStatements=true
</code></pre><p>PrepareStatement在执行executeBatch的时候，会对该参数进行判断，来进行批量操作。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">int</span>[] executeBatch() <span class="keyword">throws</span> SQLException &#123;</div><div class="line">     <span class="keyword">synchronized</span> (checkClosed().getConnectionMutex()) &#123;</div><div class="line">    </div><div class="line">          <span class="keyword">if</span> (<span class="keyword">this</span>.connection.isReadOnly()) &#123;</div><div class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> SQLException(Messages.getString(<span class="string">"PreparedStatement.25"</span>) <span class="comment">//$NON-NLS-1$</span></div><div class="line">                         + Messages.getString(<span class="string">"PreparedStatement.26"</span>), <span class="comment">//$NON-NLS-1$</span></div><div class="line">                         SQLError.SQL_STATE_ILLEGAL_ARGUMENT);</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          <span class="keyword">if</span> (<span class="keyword">this</span>.batchedArgs == <span class="keyword">null</span> || <span class="keyword">this</span>.batchedArgs.size() == <span class="number">0</span>) &#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">0</span>];</div><div class="line">       &#125;</div><div class="line"></div><div class="line">          <span class="comment">// we timeout the entire batch, not individual statements</span></div><div class="line">          <span class="keyword">int</span> batchTimeout = <span class="keyword">this</span>.timeoutInMillis;</div><div class="line">          <span class="keyword">this</span>.timeoutInMillis = <span class="number">0</span>;</div><div class="line">    </div><div class="line">          resetCancelledState();</div><div class="line">         </div><div class="line">          <span class="keyword">try</span> &#123;</div><div class="line">               statementBegins();</div><div class="line">              </div><div class="line">               clearWarnings();</div><div class="line"></div><div class="line">               <span class="keyword">if</span> (!<span class="keyword">this</span>.batchHasPlainStatements</div><div class="line">                         &amp;&amp; <span class="keyword">this</span>.connection.getRewriteBatchedStatements()) &#123;</div><div class="line">                   </div><div class="line">                   </div><div class="line">                    <span class="keyword">if</span> (canRewriteAsMultiValueInsertAtSqlLevel()) &#123;</div><div class="line">                         <span class="keyword">return</span> executeBatchedInserts(batchTimeout);</div><div class="line">                    &#125;</div><div class="line">                   </div><div class="line">                    <span class="keyword">if</span> (<span class="keyword">this</span>.connection.versionMeetsMinimum(<span class="number">4</span>, <span class="number">1</span>, <span class="number">0</span>)</div><div class="line">                              &amp;&amp; !<span class="keyword">this</span>.batchHasPlainStatements</div><div class="line">                              &amp;&amp; <span class="keyword">this</span>.batchedArgs != <span class="keyword">null</span></div><div class="line">                              &amp;&amp; <span class="keyword">this</span>.batchedArgs.size() &gt; <span class="number">3</span> <span class="comment">/* cost of option setting rt-wise */</span>) &#123;</div><div class="line">                         <span class="keyword">return</span> executePreparedBatchAsMultiStatement(batchTimeout);</div><div class="line">                    &#125;</div><div class="line">               &#125;</div><div class="line"></div><div class="line">               <span class="keyword">return</span> executeBatchSerially(batchTimeout);</div><div class="line">          &#125; <span class="keyword">finally</span> &#123;</div><div class="line">               <span class="keyword">this</span>.statementExecuting.set(<span class="keyword">false</span>);</div><div class="line">              </div><div class="line">               clearBatch();</div><div class="line">          &#125;</div><div class="line">     &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>需要指出的时，该参数在JDBC <strong>5.1.8</strong>开始才开始支持，<strong>5.1.17</strong>进行了优化，如果采用该机制，期望采用<code>5.1.17+</code>的版本。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JDBC/">JDBC</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MySQL/">MySQL</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/MySQL/">MySQL</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Da-jian-bo-ke-huan-jing" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2014/07/28/Da-jian-bo-ke-huan-jing/" class="article-date">
  	<time datetime="2014-07-28T15:29:58.000Z" itemprop="datePublished">2014-07-28</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/07/28/Da-jian-bo-ke-huan-jing/">搭建博客环境</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>今天在Mac下搭建了Hexo环境，先说说搭建环境方面的问题。</p>
 <p> 

</p><p>###<strong>环境准备</strong></p>
<hr>
<p>Mac环境下最好先安装homeblew，避免后续的各种麻烦，安装过程非常简单：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ ruby -e <span class="string">"<span class="variable">$(curl -fsSL https://raw.github.com/Homebrew/homebrew/go/install)</span>"</span></div></pre></td></tr></table></figure>
<p>然后用blew安装Node.js环境。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ blew install node</div></pre></td></tr></table></figure>
<p>接下来进行hexo的安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ npm install -g hexo</div></pre></td></tr></table></figure>
<p>简单的等待后，一切就绪，然后可以进行相关目录，初始化博客目录。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ hexo init github-blog</div><div class="line">$ <span class="built_in">cd</span> github-blog</div><div class="line">$ npm install</div></pre></td></tr></table></figure>
<p>接下来就可以对<strong>_config.yml</strong>等文件进行配置，进行博客撰写了。</p>
<p></p><p>  </p>
<p>###<strong>博客发布</strong></p>
<hr>
<p>配置github信息</p>
<pre><code>deploy:
  type: github
  repository: https://github.com/home3k/home3k.github.io.git
  branch: master
</code></pre><p>接下来进行发布即可。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo deploy --generate</div></pre></td></tr></table></figure></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Blog/">Blog</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Hexo/">Hexo</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Blog/">Blog</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Start-up" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2014/07/28/Start-up/" class="article-date">
  	<time datetime="2014-07-28T15:20:28.000Z" itemprop="datePublished">2014-07-28</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/07/28/Start-up/">起步</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>有一段时间，经常会写写东西。不过，如梭带来了浮躁，浮躁带来的懒惰，慢慢地，文字就停了。</p>
<p>从今天开始，采用<a href="http://zh.wikipedia.org/wiki/Markdown" target="_blank" rel="external">Markdown</a>+<a href="http://hexo.io/" target="_blank" rel="external">hexo</a>写自己的独立博客。之前的博客内容，也全部迁移过来。技术博客托管在Github上，生活博客托管在Gitcafe上。</p>
<p>希望自己能够坚持写下去，加油！</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ blog start</div></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Blog/">Blog</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Blog/">Blog</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Vertx" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2012/11/08/Vertx/" class="article-date">
  	<time datetime="2012-11-08T08:26:34.000Z" itemprop="datePublished">2012-11-08</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2012/11/08/Vertx/">初始Vert.x</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Vert.x框架最近比较火，它号称JVM上的Node.js。 </p>
<p><a href="http://vertx.io/" target="_blank" rel="external">http://vertx.io/</a></p>
<p>它目前支持JavaScript，Groovy，Ruby，Java，正在对Clojure，Scala，Python等。跟node.js一样，它是异步的、基于EDA的架构，跟Node.js一样，它拥有良好的并发及消息传递性能。</p>
<p>它支持HTTP/HTTPS,同时支持<a href="https://en.wikipedia.org/wiki/WebSockets" target="_blank" rel="external">WebSockets</a>,<a href="https://github.com/sockjs/sockjs-client" target="_blank" rel="external">sockjs</a>等高级协议。</p>
<p>其官方的benchmark相当漂亮：</p>
<center><img src="http://home3k-blog.qiniudn.com/Vertx-benchmark.png" alt="Vert.x Benchmark"></center>   

<p><br></p>
<p>###event-driven模型</p>
<p>在vert.x内部，每一个vert.x实例称为一个verticle。verticle被bind到一个统一的event bus上，进行事件循环。其中一部分verticle是提供一些共享的lib（如共享的event handler），这种verticle被称为busmod。</p>
<p>通过event bus，Verticle可与运行在相同或不同vert.x实例中的其他verticle进行通信（基于<a href="http://en.wikipedia.org/wiki/Actor_model" target="_blank" rel="external">Actor model</a>）。</p>
<center><img src="http://home3k-blog.qiniudn.com/Vertx-verticle.png" alt="Vert.x verticle"></center>   


<p><br></p>
<p>###vert.x的线程模型</p>
<p>在vert.x中，每一个verticle(busmod)都被绑定到一个特殊的线程，所以在对verticle进行开发时，无需关注他的线程安全性。因此，对于vert.x instance，它管理着一个Thread Set，每个线程都维护了一个event loop。vert.x内部通过一个线程池，选择将一个event循环分配给具体的verticle。具体的线程响应模型采用了<a href="http://en.wikipedia.org/wiki/Reactor_pattern" target="_blank" rel="external">Reactor pattern</a><br><br></p>
<p>###内部实现</p>
<p>从其事件处理流程上很容易想到netty，vert.x在底层确实使用了netty。通过netty来处理高并发响应，reactor式的分派请求。vertx的ClusterManager基于Hazelcast进行轻量级实现。</p>
<p>具体细节还得看代码细节，有机会再分享<a href="https://github.com/vert-x/vert.x" target="_blank" rel="external">https://github.com/vert-x/vert.x</a></p>
<p>简单的实现demo</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Vertx vertx = Vertx .newVertx();</div><div class="line">vertx.createHttpServer().requestHandler(</div><div class="line">             <span class="keyword">new</span> Handler&lt; HttpServerRequest&gt;() &#123;</div><div class="line">                   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(HttpServerRequest req)</span> </span>&#123;</div><div class="line">                        String file = req.path.equals( <span class="string">"/"</span> ) ? <span class="string">"index.html"</span></div><div class="line">                                    : req.path;</div><div class="line">                        req.response.sendFile( <span class="string">"webroot/"</span> + file);</div><div class="line">                  &#125;</div><div class="line">            &#125;).listen(<span class="number">8080</span>);</div></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Vert-x/">Vert.x</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Vert-x/">Vert.x</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Direct-memory" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2012/09/06/Direct-memory/" class="article-date">
  	<time datetime="2012-09-06T08:34:48.000Z" itemprop="datePublished">2012-09-06</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2012/09/06/Direct-memory/">DirectMemory源码分析</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>最近对cache相关进行了调研，看了一下off-heap cache DirectMemory源码，对其进行如下梳理：<br>源码路径：<a href="https://github.com/raffaeleguidi/DirectMemory" target="_blank" rel="external">https://github.com/raffaeleguidi/DirectMemory</a><br><br></p>
<p>###引</p>
<p>Java cache通常的做法是通过缓存对象报错在heap，通过一定的持久化机制保存在disk。为了防止缓存对象被gc，通常用弱引用等wrap一下。</p>
<p>考虑到heap容量，缓存达到一定的容量必然会发生gc(full)，由于full gc的STW，当heap容量达到10g以上时的pause time几乎是无法容忍的。</p>
<p>为了防止gc带来的性能问题，部分cache系统开始使用off-heap机制，通过对堆外内存的自主管理，防止额外的性能问题。这里面比较典型的是ehcache被terracotta收购后推出的BigMemory(<a href="http://www.ehcache.org/documentation/user-guide/bigmemory" target="_blank" rel="external">http://www.ehcache.org/documentation/user-guide/bigmemory</a>)</p>
<p>根据terracotta测试，BigMemory在350G+的场景下，表现良好。</p>
<p>由于BigMemory不开源，有个开源版的DirectMemory，实现跟其比较类似。<br><br></p>
<p>###DirectMemory</p>
<p>DirectMemory代码结构比较简单：</p>
<center><img src="http://home3k-blog.qiniudn.com/Direct-Memory-Code.png" alt="DirectMemory代码结构"></center>

<p>下面结合其源码及数据的put操作，对其进行介绍：<br><br></p>
<p>####Cache</p>
<p>Cache作为入口，它通过ConcurrentMap 维护了String-&gt;Pointer，该Map的作用，后面会有介绍。该map通过google guava框架的MapMaker创建(可以方便的进行超时事件等)</p>
<p>Cache作为DirectMemory的入口，暴露了缓存操作的大部分接口，如put retrieve free等</p>
<p>需要指出的是，为了防止cache实例进入heap，cache的创建，属性同时通过static创建的。这也导致Cache在同一个JVM中是singleton的，无法根据需求创建多个cache</p>
<p>Cache层对对象的序列化是通过serialization包下的序列化器进行的，默认采用的是ProtoStuff。</p>
<p>下面是其put操作代码，从代码可以看到，Cache层主要通过调用memory包下的MemoryManager相应接口，进行cache的各种操作。同时操作后更新其本层Map<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Pointer <span class="title">putByteArray</span> <span class="params">(String key, <span class="keyword">byte</span>[] payload, <span class="keyword">int</span> expiresIn)</span> </span>&#123;</div><div class="line">      Pointer ptr = MemoryManager. store(payload, expiresIn);</div><div class="line">       map.put(key, ptr);</div><div class="line">       <span class="keyword">return</span> ptr;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><br></p>
<p>####MemoryManager</p>
<p>MemoryManager维护了<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;OffHeapMemoryBuffer&gt; buffers = <span class="keyword">new</span> Vector&lt;OffHeapMemoryBuffer&gt;();</div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> OffHeapMemoryBuffer activeBuffer = <span class="keyword">null</span>;</div></pre></td></tr></table></figure></p>
<p>activeBuffer即为当前buffer，如果当前buffer满了，则跳到buffers的下一个buffer中，这些buffer在buffers中，很显然，通过对buffer的分片，可以较好的提高并发度。</p>
<p>下面的代码是MemoryManager进行store操作的过程，里面用很明显的逻辑进行了切（分）片操作。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Pointer <span class="title">store</span><span class="params">(<span class="keyword">byte</span>[] payload, <span class="keyword">int</span> expiresIn)</span> </span>&#123;</div><div class="line">      Pointer p = activeBuffer .store(payload, expiresIn);</div><div class="line">       <span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123;</div><div class="line">             <span class="keyword">if</span> (activeBuffer.bufferNumber+<span class="number">1</span> == buffers.size()) &#123;</div><div class="line">                   <span class="keyword">return</span> <span class="keyword">null</span> ;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                   <span class="comment">// try next buffer</span></div><div class="line">                   activeBuffer = buffers.get(activeBuffer.bufferNumber+<span class="number">1</span>);</div><div class="line">                  p = activeBuffer .store(payload, expiresIn);</div><div class="line">            &#125;</div><div class="line">      &#125;</div><div class="line">       <span class="keyword">return</span> p;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>MemoryManager中维持的Buffer是OffHeapMemoryBuffer。<br><br></p>
<p>####OffHeapMemoryBuffer</p>
<p>OffHeapMemoryBuffer是off-heap写入的核心组件，其核心为一个<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> ByteBuffer buffer ;</div></pre></td></tr></table></figure></p>
<p>通过<code>ByteBuffer.allocateDirect(capacity)</code>，生成的DirectByteBuffer。作为NIO提供的Buffer，它可以更高效的进行off-heap操作。</p>
<p>为了更高效的进行buffer读写，它提供了<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> List&lt;Pointer&gt; pointers = <span class="keyword">new</span> ArrayList&lt;Pointer&gt;();。</div></pre></td></tr></table></figure></p>
<p>对于Pointer对象，其核心字段：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"> <span class="keyword">public</span> <span class="keyword">int</span> start ;  <span class="comment">//buffer的开始位置</span></div><div class="line"> <span class="keyword">public</span> <span class="keyword">int</span> end ;    <span class="comment">//buffer的结束位置</span></div><div class="line"> <span class="keyword">public</span> <span class="keyword">boolean</span> free ; <span class="comment">//pointer是否可用</span></div><div class="line"> <span class="keyword">public</span> <span class="keyword">int</span> bufferNumber ; <span class="comment">//所属的buffer number</span></div><div class="line">.....</div></pre></td></tr></table></figure></p>
<p>从本质上讲，它标识了一个buffer分片。通过将数据存储在这些细粒度分片上，可以更好的进行数据获取，并可以围绕key进行必要的操作，例如：Cache中包含一个key-Pointer的ConcurrentHashMap，这样在进行retrieve或update操作时，可以通过key先获得Pointer，然后可以通过pointer快速地对buffer进行操作。</p>
<p>初始化时，Pointer为buffer大小。每次store的时候，先查找是否有free的Pointer，如果存在，执行slice，将原来的pointer切分出一块数据大小的新的pointer，封装pointer属性，然后slice buffer，并忘buffer里写数据。同时将报错数据的pointer放入到pointers中。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> Pointer <span class="title">store</span><span class="params">(<span class="keyword">byte</span>[] payload, <span class="keyword">long</span> expiresIn, <span class="keyword">long</span> expires)</span> </span>&#123;</div><div class="line">       Pointer goodOne = firstMatch(payload. length);</div><div class="line">       </div><div class="line">        <span class="keyword">if</span> (goodOne == <span class="keyword">null</span> ) &#123;</div><div class="line">              <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"did not find a suitable buffer"</span>);</div><div class="line">       &#125;</div><div class="line">       </div><div class="line">       Pointer fresh = slice(goodOne, payload. length);</div><div class="line"></div><div class="line"></div><div class="line">       fresh. created = System.currentTimeMillis();</div><div class="line">        <span class="keyword">if</span> (expiresIn &gt; <span class="number">0</span>) &#123;</div><div class="line">             fresh. expiresIn = expiresIn;</div><div class="line">             fresh. expires = <span class="number">0</span>;</div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (expires &gt; <span class="number">0</span>) &#123;</div><div class="line">             fresh. expiresIn = <span class="number">0</span>;</div><div class="line">             fresh. expires = expires;</div><div class="line">       &#125;</div><div class="line">       </div><div class="line">       fresh. free = <span class="keyword">false</span> ;</div><div class="line">        used.addAndGet(payload.length );</div><div class="line">       ByteBuffer buf = buffer.slice();</div><div class="line">       buf.position(fresh. start);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">             buf.put(payload);</div><div class="line">       &#125; <span class="keyword">catch</span> (BufferOverflowException e) &#123;</div><div class="line">              <span class="comment">// RpG not convincing - let's fix it later</span></div><div class="line">             goodOne. start = fresh.start ;</div><div class="line">             goodOne. end = buffer .limit();</div><div class="line">              <span class="keyword">return</span> <span class="keyword">null</span> ;</div><div class="line">       &#125;</div><div class="line">        pointers.add(fresh);</div><div class="line">        <span class="keyword">return</span> fresh;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p><br></p>
<p>###其他</p>
<ol>
<li>从MemoryManager store操作代码可以看到，当store操作时，如果当前buffer空间不足时，直接进行换切片操作，显然如果数据非常大时，OffHeapMemoryBuffer存在空间浪费。同时纵观其代码，其内存管理比较粗，目前基本只涉及过期处理，LFU策略等。Pointer空间释放后，也没有必要的合并操作。内存空间浪费应该是个问题。</li>
<li>key过期处理时，对Pointer进行查找时，在设计上采用了JoSQL框架，通过SQL方式获得Pointer，代码比较明晰。</li>
</ol>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Cache/">Cache</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DirectMemory/">DirectMemory</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Java/">Java</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-False-sharing" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2012/06/27/False-sharing/" class="article-date">
  	<time datetime="2012-06-27T05:41:45.000Z" itemprop="datePublished">2012-06-27</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2012/06/27/False-sharing/">伪共享</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>近期对并发编程进行了研究，看到已经从jsr166y添加到java 7里的LinkedTransferQueue及Disruptor框架均有对<code>伪共享(False Sharing)</code>问题进行了单独的处理，于是，对此类问题进行了梳理：</p>
<p>目前典型的CPU架构有三级缓存，从读取速度由快而慢分别为L1 -&gt; L2 -&gt;L3。对于多核架构，L1，L2为单核独享，而L3为多核共享。CPU指令执行即从L1 cache开始读取，如果cache miss，便从下一级cache读取，直到内存。 </p>
<p>为了高效利用cache，CPU不是简单地将单条数据(指令)写入cache，而是将一批数据指令(连续地)写入cache行中。即cache行是对cache进行读写操作的最小单位。对于目前典型的core，ivy，sandy等cpu，cache行大小为64bytes。 </p>
<p>同时，对于多核系统，每个核有私有的L1，L2，多线程并发时，如果某个核需要修改的变量同时在另外一个核的cache中，为了保证数据的一致性，需要使当前核cache中变量失效(invalidate)，然后同步一致数据。这种操作是有硬件层级的缓存一致性协议来保证的，通常是M-E-S-I协议。其中M,E,S和I代表使用cache行所处的四个状态，协议通过四种状态的(复杂)迁移(类似状态机模型)来保证一致性。当发生上述不一致时，当前核会发出RFO(Request For Owner)请求来保证一致性，但是这个保证过程需要低层级cache或者内存的同步，会对性能造成很大的影响。<br>对于Java对象，相邻的成员变量被加载到同一个cache行中，当不同线程对成员变量分别操作时，就会导致RF0请求的发生，这种现象即伪共享。</p>
<center><img src="http://home3k-blog.qiniudn.com/Disruptor-false-sharing.png" alt="Disruptor设计示意图"></center>

<p>上图为disruptor作者设计的示意图，x，y变量分别被load到c1，c2的cache行中，c1更新x，c2更新y，而x，y位于同一条cache行中，此时两个线程轮番发送RFO消息，占有cache行拥有权，获得拥有权线程对变量的更新会导致其他核中的cache行中的变量失效，进而通过L3进行变量同步，而此时如果L3 miss，还需要通过内存同步，对性能造成很大的影响。因此，虽然x，y被独立线程操作，彼此无任何关系，因为伪共享，性能有很大的问题。<br>比较悲催的是，上面的x，y变量的伪共享在生产者-消费者模式中比较常见。生产者-消费者模式中，生产者和消费者作为不同的线程不停地操作队列的首尾两端(通过head,tail指针)，而这两个指针对象定义在一起，加载head时，会将tail同时加载到同一个cache line中。</p>
<p>例如：Java j.u.c LinkedBlockingQueue的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"> <span class="comment">/** Head of linked list */</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">transient</span> Node&lt;E&gt; head;</div><div class="line"> </div><div class="line"><span class="comment">/** Tail of linked list */</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">transient</span> Node&lt;E&gt; last;</div></pre></td></tr></table></figure>
<p>head，last共占8bytes。两者被加载到同一个cache line。大量的生产者、消费者对queue进行读写时，会发生较大的性能问题</p>
<p>为了防止伪共享的发生，通常进行缓存行补齐(cache line padding)，即对对象进行填充，使其占用一个cache行。这样可以保证对象不处于同一缓存行。</p>
<p>对于Hotspot Java对象，Java程序的对象头固定占8字节(32位系统)，此时只需要填48bytes即可保证对象处于,不同的缓存行, 从而避免伪共享。(对于64位系统，对象头占用空间更大，多出也无所。)</p>
<p>例如：</p>
<p>在 LinkedTransferQueue中(早期的jsr166y版本，收录在早期的netty项目中)，队列的head，tail如下定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** head of the queue */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PaddedAtomicReference&lt;QNode&gt; head;</div><div class="line">    <span class="comment">/** tail of the queue */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PaddedAtomicReference&lt;QNode&gt; tail;</div><div class="line"> </div><div class="line"> </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Padded version of AtomicReference used for head, tail and</div><div class="line">     * cleanMe, to alleviate contention across threads CASing one vs</div><div class="line">     * the other.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">PaddedAtomicReference</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">AtomicReference</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">4684288940772921317L</span>;</div><div class="line"> </div><div class="line">        <span class="comment">// enough padding for 64bytes with 4byte refs</span></div><div class="line">        Object p0, p1, p2, p3, p4, p5, p6, p7, p8, p9, pa, pb, pc, pd, pe;</div><div class="line">        PaddedAtomicReference(T r) &#123; <span class="keyword">super</span>(r); &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>PaddedAtomicReference通过15个4byte对象，对AtomicReference进行了填充，从避免了伪共享，LinkedTransferQueue后期版本对其设计进行了更新，但核心类似，只是方法更加优雅（还没有完全看懂）。</p>
<p>在Disruptor框架中，其核心数据结构RingBuffer的序号由Sequence对象来维护，Sequence对象，定义了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span>[] paddedValue = <span class="keyword">new</span> <span class="keyword">long</span>[<span class="number">15</span>];</div></pre></td></tr></table></figure>
<p>通过15个long来填充。序号设置/获取时分别调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">get</span><span class="params">()</span></span>&#123;</div><div class="line">    <span class="keyword">return</span> unsafe.getLongVolatile(paddedValue, valueOffset);</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> value)</span></span>&#123;</div><div class="line">    unsafe.putOrderedLong(paddedValue, valueOffset, value);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这样通过sun unsafe的CAS操作，对序号进行填充，从而避免了伪共享。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Cache/">Cache</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/False-Sharing/">False Sharing</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Java/">Java</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-G1-gc" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2011/12/20/G1-gc/" class="article-date">
  	<time datetime="2011-12-20T09:37:52.000Z" itemprop="datePublished">2011-12-20</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2011/12/20/G1-gc/">JAVA 7 G1收集器调研</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>最近在看虚拟机垃圾收集，看到了JAVA 7 G1收集器的相关内容，特深入调研了下。</p>
<p>G1收集器全称Garbage-First Garbage Collector。是在Java 6 Update 14中引入，旨在取代CMS收集器的一种新型收集器。在Java 6中只是试验性的引入，因各种原因没有正式引入。Java 7开始，其被正式引入。</p>
<p>作为一个server-style回收器，其具有如下属性：</p>
<h1 id="1-并行和并发"><a href="#1-并行和并发" class="headerlink" title="1. 并行和并发"></a>1. 并行和并发</h1><p>众所周知，目前所有的GC(无论是serial,parallel及近年来广泛使用的CMS)均存在暂停时间问题，所谓的暂停时间是由于GC的“stop-the-world” 机制（这个机制简称STW，即，在执行垃圾收集算法时，Java应用程序的其他所有除了垃圾收集帮助器线程之外的线程都被挂起）。而G1 可以从最新的硬件中获得并行的能力。它能够使用所有可用的CPU（CPU多核，硬件多线程，等）来加速它的STW暂停时间。虽然其并行机制在CMS中已有了一定的实现（即周期性的进行并发标记[concurrent marking phase]），但G1采用了新的实现方式。</p>
<p>该机制与G1新的堆内存管理机制相关。与其他GC收集器不同，在G1中，对象的新生代和老一代上并没有在物理上分隔开，而是把一个连续的堆内存拆分成了几个相同大小的区域。新生对象和老对象都会被放在一系列可能不连续的区域中。之所以这样做，就是为了让G1可以更灵活地移动老对象所占用的资源给新的对象。G1中的内存收集会发生 “疏散暂停”，当内存从一系列区域开始回收时，这些区域所引用的对象会被疏散到另一些区域中，这样，会有一整块的内存来重新被申请（其思想跟垃圾收集算法中的复制算法很类似）。疏散会发生整个程序的暂停，但“疏散”这些内存可以被并行运行，这正是G1的并发阶段做的事情。</p>
<h1 id="2-分代处理"><a href="#2-分代处理" class="headerlink" title="2. 分代处理"></a>2. 分代处理</h1><p>与其它的HotSpot 垃圾回收器一样，G1 也是分代的。即它在处理新分配的对象（年轻代）和已经生存了一段时间的对象（年老代）时会不同，它会更多地考虑一些新创建的对象实例，因为越新创建的就越有最大的可能性被回收，老对象只是偶尔访问一下。对于大多数的Java应用来说，这个机制可以极大地提高回收效率。</p>
<h1 id="3-紧凑内存（碎片整理"><a href="#3-紧凑内存（碎片整理" class="headerlink" title="3. 紧凑内存（碎片整理"></a>3. 紧凑内存（碎片整理</h1><p>与CMS收集器不同，G1 会对堆进行内存整理。压缩可以消除潜在的内存碎片的问题，这样程序就可以更长时间的平滑运行。</p>
<h1 id="4-预见性"><a href="#4-预见性" class="headerlink" title="4. 预见性"></a>4. 预见性</h1><p>G1 比起 CMS 来有更多的预见性。这个主要还是用来消除内存碎片的问题。内存的碎片少了，STW的暂停时间也会被减少。</p>
<p>目前G1仍然还在试验阶段，使用下面两个参数可以打开G1机制：</p>
<p><code>-XX:+UnlockExperimentalVMOptions -XX:+UseG1GC</code></p>
<p>目前G1收集器还存在如下问题：</p>
<ol>
<li>G1不支持 JVM TI JMX等工具，由于相当数量的JVM管理及监控工具都是基于这两个服务的，因此基于G1很多工具无法正确使用。</li>
<li>G1不支持增量永生代收集。因此，在应用卸载类时，无法进行收集。</li>
<li>STW的暂停时间不太稳定，与CMS相比，时好时坏。</li>
</ol>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/G1/">G1</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/GC/">GC</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Java/">Java</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-It-is-running-out" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2011/01/27/It-is-running-out/" class="article-date">
  	<time datetime="2011-01-26T16:20:00.000Z" itemprop="datePublished">2011-01-27</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2011/01/27/It-is-running-out/">It is running out</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>I think i’m drowning<br>asphyxiated<br>i wanna break this spell<br>that you’ve created </p>
<p>you’re something evil<br>a contradiction<br>i wanna finish the game<br>and kill the friction </p>
<p>But you will be the death of me<br>you are just the death of me</p>
<p>bury it<br>i wanna bury it<br>i wanna smother it<br>i wanna murder it </p>
<p>I hope it is running out<br>and I hope the time is running out</p>
<p>But I can’t push it underground<br>I can’t stop it screaming out </p>
<p>I wanted freedom<br>but I’m restricted<br>I tried to give it up<br>but I’m addicted </p>
<p>Maybe you know i’m trapped<br>sense of elation<br>I know you’ll never dream of<br>breaking this fixation </p>
<p>you will squeeze the life out of me<br>til it run out.</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/随笔/">随笔</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/随笔/">随笔</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Find-a-home" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2010/05/25/Find-a-home/" class="article-date">
  	<time datetime="2010-05-25T11:14:00.000Z" itemprop="datePublished">2010-05-25</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2010/05/25/Find-a-home/">Find a home</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <script type="text/javascript" src="http://www.xiami.com/widget/player-single?uid=0&sid=1769582690&mode=js"></script>

<p>Find A Home (New Forest Shaker)<br>　　　　　　　　　　　　　　Delays</p>
<p>One more year of digging here<br>And we’re alight in heaven; we’re alight in heaven<br>If we bare the stones and stares<br>Then we’re alight in heaven, we’re alight in heaven, </p>
<p>Mother says to hold our tongues; we are the chosen ones,<br>And we answer to no one, </p>
<p>Same dream I’m always having,<br>Like shivering, shivering, shivering… </p>
<p>Find a home amongst the trees,<br>Bend your branches over me,<br>Find a home, defy the freeze,<br>Dance around the rosaries… </p>
<p>Faith alone must clear this snow<br>Or we’ll have doubted heaven; we’ll have doubted heaven<br>It’s finisterre for dancing bears<br>If we have doubted heaven; we have doubted heaven </p>
<p>Everyone I left behind, they think I left my mind under Mesmer, sola fide<br>Same dream I’m always having,<br>Like shivering, shivering, shivering… </p>
<p>Find a home amongst the trees,<br>Bend your branches over me,<br>Find a home; defy the freeze, and glow, </p>
<p>Find a home… </p>
<p>Oh I can row, I can row, I can row back home,<br>Or we can lay, we can lay, we can lay in Sway, </p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/音乐/">音乐</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/音乐/">音乐</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Exogenesis-Symphony-Cross-Pollination" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2010/03/04/Exogenesis-Symphony-Cross-Pollination/" class="article-date">
  	<time datetime="2010-03-04T12:26:43.000Z" itemprop="datePublished">2010-03-04</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2010/03/04/Exogenesis-Symphony-Cross-Pollination/">Exogenesis Symphony, Pt. 2 Cross-Pollination</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <script type="text/javascript" src="http://www.xiami.com/widget/player-single?uid=0&sid=1769075178&mode=js"></script>

<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line">package  music.album.the.resistance;</div><div class="line"></div><div class="line">import  foobar;</div><div class="line">import  last.fm;</div><div class="line"></div><div class="line">/**</div><div class="line">*  编程需要交流</div><div class="line">* @author Muse</div><div class="line">* @author Sukani</div><div class="line">**/</div><div class="line">public class Exogenesis Symphony, Pt. 2 Cross-Pollination &#123;</div><div class="line">    </div><div class="line">    public void sing（) &#123;</div><div class="line">      /*我们不受周围人的影响*/</div><div class="line">      Rise above the crowds;</div><div class="line">      /*我们的充满辐射的环境下工作*/</div><div class="line">      Wade through toxic clouds;</div><div class="line">      /*我们要打破欧美软件列强的垄断*/</div><div class="line">      Breach the outer sphere;</div><div class="line">      /*我们虽然没有把握, 但是相互交流或许能提高*/</div><div class="line">      The edge of all our fears rest with you;</div><div class="line">      /*我们需要交流!*/</div><div class="line">      We are counting on you;</div><div class="line">      /*我们需要交流!*/</div><div class="line">      It's up to you;</div><div class="line">      /*赶紧把代码共享出来!*/</div><div class="line">      Spread our codes to the stars;</div><div class="line">      /*交流才是王道*/</div><div class="line">      You must rescue us all;</div><div class="line">      /*赶紧把代码共享出来!*/</div><div class="line">      Spread our codes to the stars;</div><div class="line">      /*交流才是王道*/</div><div class="line">      You must rescue us all;</div><div class="line">      /*告诉大家*/</div><div class="line">      Tell us;</div><div class="line">      /*你这段代码倒是是干什么用的!*/</div><div class="line">      Tell us your final wish;</div><div class="line">      /*说不明白就别想回去!*/</div><div class="line">      Now we know you can never return;</div><div class="line">      /*告诉大家*/</div><div class="line">      Tell us;</div><div class="line">      /*你这段代码倒是是干什么用的!*/</div><div class="line">      Tell us your final wish;</div><div class="line">      /*我们要Open-Source, 与全球的同行分享!*/</div><div class="line">      We will tell it to the world;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  public void afterSing() &#123;</div><div class="line">    if (action.equals("闲的!")) &#123;</div><div class="line">     System.out.println("也是被论文逼得.");</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">&#125;</div></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/随笔/">随笔</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/音乐/">音乐</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/随笔/">随笔</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/2/">&laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/4/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2010-2021 home3k
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>